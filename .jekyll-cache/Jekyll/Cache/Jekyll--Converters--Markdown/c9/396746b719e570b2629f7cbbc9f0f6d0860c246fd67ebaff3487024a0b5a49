I"Â<h2 id="ä»‹ç»">ä»‹ç»</h2>
<p>ä»¥ä¸‹ä¸ºsftpå¸¸ç”¨å·¥å…·ç±»</p>

<h2 id="sftp_helper">SFTP_HELPER</h2>
<p>helperå·¥å…·ç±»</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Slf4j
public class SftpHelper {
    /**
     * host
     */
    private final String host;
    /**
     * ç«¯å£
     */
    private final int port;
    /**
     * ç”¨æˆ·åç§°
     */
    private final String username;
    /**
     * å¯†ç 
     */
    private final String password;
    /**
     * æœ¬åœ°å­˜å‚¨è·¯å¾„
     */
    @Value("${local.file.path}")
    private String localFilePath;
    public SftpHelper(String host, int port, String username, String password) {
        this.host = host;
        this.port = port;
        this.username = username;
        this.password = password;
    }

    /**
     * @param remoteDir è¿œç¨‹æ–‡ä»¶å¤¹
     * @param fileName  æ–‡ä»¶åç§°
     */
    public void download(String remoteDir, String fileName, String localDir) throws JSchException, InterruptedException {
        SftpUtils sftpUtil = new SftpUtils();
        ChannelSftp sftp = sftpUtil.connect(host, port, username, password);
        try {
            sftpUtil.download(sftp, remoteDir, fileName, localDir);
        } catch (Exception e) {
            log.error("æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œ1ç§’åé‡è¯•ä¸€æ¬¡ï¼ŒremoteDir={}, fileName={}ï¼Œerror={}", remoteDir, fileName, e.getMessage(), e);
            Thread.sleep(1000);
            try {
                sftpUtil.download(sftp, remoteDir, fileName, localDir);
            } catch (Exception e1) {
                log.error("æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œé‡è¯•1æ¬¡ä¾æ—§å¤±è´¥ï¼ŒremoteDir={}, fileName={}ï¼Œerror={}", remoteDir, fileName, e1.getMessage(), e1);
            }
        }
        sftpUtil.logout();
        String fileZipLocalAddress = localDir + "/" + fileName;
        // æœ¬åœ°å­˜å‚¨zipå…¨è·¯å¾„
        try {
            if (new File(fileZipLocalAddress).exists()) {
                // TODO ä¸ºç©ºï¼Œåˆ™ä¸€ç›´å‘Šè­¦
                UnzipUtils.unzip(fileZipLocalAddress, localDir);
                return;
            }
            log.warn("unzip.error, zip.not.exists");
        } catch (IOException e) {
            log.error("unzip.error", e);
        }
    }

    /**
     * åˆ é™¤æœ¬åœ°tmp dir
     *
     * @param localDir æœ¬åœ°æ–‡ä»¶
     */
    public void deleteDir(String localDir) {
        try {
            File workDirFile = new File(localDir);
            if (workDirFile.exists()) {
                FileUtils.deleteDirectory(workDirFile);
            }
        } catch (Exception e) {
            log.error("deleteDirectory.error, dir:{}", localDir, e);
        }
    }

    /**
     * åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹
     *
     * @return ä¸´æ—¶æ–‡ä»¶å¤¹è·¯å¾„
     * @throws Exception å¼‚å¸¸
     */
    public String createTmpDir(String tmpDirName) throws Exception {
        File localDir = new File(localFilePath + tmpDirName);
        int maxRetry = 3;
        while (localDir.exists() &amp;&amp; maxRetry &gt; 0) {
            TimeUnit.MILLISECONDS.sleep(10);
            localDir = new File(localFilePath + tmpDirName + maxRetry);
            maxRetry--;
        }
        if (localDir.exists()) {
            throw new RuntimeException("localDir " + "ã€" + localDir + "ã€‘" + "exist");
        }
        Files.createDirectories(Paths.get(localDir.getAbsolutePath()));
        log.info("localDiræœ¬åœ°ä¸´æ—¶æ–‡ä»¶å¤¹ : {}", localDir);
        return localDir.toString();
    }

    /**
     * è·å–è¿œç¨‹ç›®å½•ä¸‹æ–‡ä»¶é›†åˆ
     *
     * @param remotePath è¿œç¨‹æ–‡ä»¶è·¯å¾„
     * @return æ–‡ä»¶é›†åˆ
     */
    public List&lt;String&gt; ls(String remotePath) {
        SftpUtils sftpUtil = new SftpUtils();
        List&lt;String&gt; files = Lists.newArrayList();
        try {
            ChannelSftp sftp = sftpUtil.connect(host, port, username, password);
            @SuppressWarnings("unchecked")
            List&lt;ChannelSftp.LsEntry&gt; lsEntryList = Lists.newArrayList(sftp.ls(remotePath));
            for (ChannelSftp.LsEntry lse : lsEntryList) {
                files.add(lse.getFilename());
            }
        } catch (Exception e) {
            log.warn("è·å–è¿œç¨‹ç›®å½•ä¸‹æ–‡ä»¶é›†åˆå¤±è´¥", e);
        } finally {
            sftpUtil.logout();
        }
        return files;
    }
</code></pre></div></div>

<p>ã€€</p>

<h2 id="sftp_util">SFTP_UTIL</h2>
<p>sftpUtilåº•å±‚è¿æ¥</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class SftpUtils {
    private ChannelSftp channel;

    private Session session;

    /**
     * åˆ›å»ºè¿æ¥
     *
     * @return channelé“¾æ¥
     * @throws JSchException JSchExceptionå¼‚å¸¸
     */
    public ChannelSftp connect(String host, int port, String username, String password) throws JSchException {
        JSch jsch = new JSch();
        session = jsch.getSession(username, host, port);
        session.setPassword(password);

        Properties config = new Properties();
        //è·³è¿‡å…¬é’¥æ£€æŸ¥
        config.setProperty("StrictHostKeyChecking", "no");
        session.setConfig(config);

        session.connect(10000);
        channel = (ChannelSftp) session.openChannel("sftp");
        channel.connect(100000);
        return channel;
    }

    /**
     * å…³é—­è¿æ¥ server
     */
    public void logout() {
        if (channel != null &amp;&amp; channel.isConnected()) {
            channel.disconnect();
        }
        if (session != null &amp;&amp; session.isConnected()) {
            session.disconnect();
        }
    }
    
    
    /**
     * ä¸Šä¼ æ–‡ä»¶
     * @param sftp
     * @param remoteDir
     * @param file
     * @throws Exception
     */
    public  void upload(ChannelSftp sftp, String remoteDir, File file) throws Exception{
        sftp.cd(remoteDir);
        InputStream inputStream = new FileInputStream(file);
        sftp.put(inputStream,file.getName());
    }
    

    /**
     * ä¸‹è½½æ–‡ä»¶
     *
     * @param sftp sftp
     * @param remoteDir è¿œç¨‹æ–‡ä»¶
     * @param fileName æ–‡ä»¶åç§°
     * @param localDir æœ¬åœ°æ–‡ä»¶
     * @throws SftpException sftpå¼‚å¸¸
     * @throws FileNotFoundException æ–‡ä»¶æœªå‘ç°å¼‚å¸¸
     */
    public void download(ChannelSftp sftp, String remoteDir, String fileName, String localDir) throws SftpException, FileNotFoundException {
        String dir = localDir + "//" + fileName;
        sftp.cd(remoteDir);
        File file = new File(dir);
        sftp.get(fileName, new FileOutputStream(file));
    }  
}
</code></pre></div></div>

:ET